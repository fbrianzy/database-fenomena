{% extends "base.html" %}

{% block title %}Trend Chart{% endblock %}

{% block content %}
<!-- Error Message Display -->
{% if error_message %}
<div class="glass rounded-3xl p-6 mb-8 border-l-4 border-yellow-500">
    <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mr-4"></i>
        <div>
            <h3 class="text-lg font-semibold text-white">Peringatan</h3>
            <p class="text-blue-200">{{ error_message }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Data Filter Info - BARU DITAMBAHKAN -->
{% if chart_data.statistics.total_data == 0 %}
<div class="glass rounded-3xl p-6 mb-8 border-l-4 border-red-500">
    <div class="flex items-center">
        <i class="fas fa-info-circle text-red-400 text-2xl mr-4"></i>
        <div>
            <h3 class="text-lg font-semibold text-white">Informasi Filter Data</h3>
            <p class="text-blue-200">Tidak ada data yang tersedia setelah filtering data kosong. Semua data telah difilter karena memiliki field yang kosong (Kategori, Ringkasan Fenomena, atau Sentiment/Tren Harga).</p>
            <p class="text-blue-300 text-sm mt-2">
                <i class="fas fa-lightbulb mr-1"></i>
                Tip: Coba pilih sumber data yang berbeda atau pastikan data CSV memiliki field yang lengkap.
            </p>
        </div>
    </div>
</div>
{% else %}
<div class="glass rounded-3xl p-6 mb-8 border-l-4 border-green-500">
    <div class="flex items-center">
        <i class="fas fa-check-circle text-green-400 text-2xl mr-4"></i>
        <div>
            <h3 class="text-lg font-semibold text-white">Status Filter Data</h3>
            <p class="text-blue-200">
                Total data: {{ chart_data.statistics.total_raw_data or chart_data.statistics.total_data }} | 
                Data valid untuk chart: {{ chart_data.statistics.total_data }} | 
                Data kosong: {{ (chart_data.statistics.total_raw_data or chart_data.statistics.total_data) - chart_data.statistics.total_data }}
            </p>
            <p class="text-blue-300 text-sm mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                Chart menampilkan hanya data valid, tapi statistik total tetap menghitung semua data.
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Page Header -->
<div class="glass rounded-3xl p-8 mb-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">
                <i class="fas fa-chart-line mr-3 text-green-400"></i>
                Visualisasi Tren Fenomena
            </h1>
            <p class="text-blue-200 text-lg">Analisis perkembangan fenomena dari waktu ke waktu (Data yang Valid)</p>
        </div>
        <div class="hidden md:block">
            <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center">
                <i class="fas fa-chart-area text-white text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Chart Controls -->
<div class="glass rounded-3xl p-6 mb-8">
    <h2 class="text-xl font-bold text-white mb-6 flex items-center">
        <i class="fas fa-sliders-h mr-3 text-purple-400"></i>
        Kontrol Visualisasi
    </h2>
    
    <form method="get" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Tahun (NEW) -->
            <div class="space-y-2">
                <label class="text-blue-200 text-sm font-medium flex items-center">
                    <i class="fas fa-hourglass-half mr-2"></i>
                    Tahun
                </label>
                <select name="tahun" id="tahunSelect" class="w-full p-4 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-xl text-white focus:ring-2 focus:ring-green-400 focus:border-transparent transition-all duration-300">
                    <option value="" class="text-gray-800">Semua Tahun</option>
                    {% for t in tahun_list %}
                    <option value="{{ t }}" {% if selected_tahun == t %}selected{% endif %} class="text-gray-800">{{ t }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Data Source -->
            <div class="space-y-2">
                <label class="text-blue-200 text-sm font-medium flex items-center">
                    <i class="fas fa-database mr-2"></i>
                    Sumber Data
                </label>
                <select name="jenis_data" id="dataSource" class="w-full p-4 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-xl text-white focus:ring-2 focus:ring-green-400 focus:border-transparent transition-all duration-300" onchange="handleDataSourceChange(this.value)">
                    {% for jenis in jenis_data_list %}
                    <option value="{{ jenis.value }}" {% if selected_jenis_data == jenis.value %}selected{% endif %} class="text-gray-800">{{ jenis.label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Chart Type -->
            <div class="space-y-2">
                <label class="text-blue-200 text-sm font-medium flex items-center">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Tipe Grafik
                </label>
                <select id="chartType" class="w-full p-4 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-xl text-white focus:ring-2 focus:ring-green-400 focus:border-transparent transition-all duration-300">
                    <option value="line" data-fill="false" class="text-gray-800">Line Chart</option>
                    <option value="bar" class="text-gray-800">Bar Chart</option>
                    <option value="line" data-fill="true" class="text-gray-800">Area Chart</option>
                </select>
            </div>

            <!-- Current Data Info -->
            <div class="space-y-2">
                <label class="text-blue-200 text-sm font-medium flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Data Aktif
                </label>
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-sm"></i>
                        </div>
                        <div>
                            <p class="text-white font-semibold text-sm">
                                {% for jenis in jenis_data_list %}
                                    {% if selected_jenis_data == jenis.value %}{{ jenis.label }}{% endif %}
                                {% endfor %}
                            </p>
                            <p class="text-blue-200 text-xs">{{ chart_data.statistics.total_data }} valid / {{ chart_data.statistics.total_raw_data or chart_data.statistics.total_data }} total</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Update Button -->
            <div class="space-y-2">
                <label class="text-blue-200 text-sm font-medium opacity-0">Update</label>
                <button type="button" onclick="updateCharts()" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white p-4 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Filter Info Row - BARU DITAMBAHKAN -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 bg-opacity-20 rounded-xl p-4 border border-blue-400 border-opacity-30">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-filter text-blue-400 text-lg"></i>
                    <div>
                        <p class="text-white font-medium">Filter Data untuk Chart</p>
                        <p class="text-blue-200 text-sm">Chart: data valid | Statistik: semua data</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-white font-bold">{{ chart_data.statistics.total_data }} / {{ chart_data.statistics.total_raw_data or chart_data.statistics.total_data }}</p>
                    <p class="text-blue-300 text-sm">Valid / Total</p>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Statistics Summary -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <!-- Total Data -->
    <div class="glass rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-200 text-sm font-medium mb-1">Total Semua Data</p>
                <p class="text-white text-3xl font-bold" id="stat-total">{{ chart_data.statistics.total_raw_data or chart_data.statistics.total_data }}</p>
                <p class="text-blue-300 text-sm mt-2">
                    <i class="fas fa-database mr-1"></i>
                    Valid: {{ chart_data.statistics.total_data }} | Kosong: {{ (chart_data.statistics.total_raw_data or chart_data.statistics.total_data) - chart_data.statistics.total_data }}
                </p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center">
                <i class="fas fa-database text-white text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Growth Rate -->
    <div class="glass rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-green-200 text-sm font-medium mb-1">Growth Rate</p>
                <p class="text-white text-3xl font-bold" id="stat-growth">
                    {% if chart_data.statistics.growth_rate > 0 %}+{% endif %}{{ chart_data.statistics.growth_rate }}%
                </p>
                <p class="text-green-300 text-sm mt-2">
                    <i class="fas fa-arrow-trend-up mr-1"></i>
                    Compared to earlier
                </p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center">
                <i class="fas fa-arrow-trend-up text-white text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Peak Activity -->
    <div class="glass rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-red-200 text-sm font-medium mb-1">Peak Activity</p>
                <p class="text-white text-2xl font-bold" id="stat-peak">{{ chart_data.statistics.peak_month }}</p>
                <p class="text-red-300 text-sm mt-2">
                    <i class="fas fa-mountain mr-1"></i>
                Highest recorded month
                </p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl flex items-center justify-center">
                <i class="fas fa-mountain text-white text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Dynamic Sentiment/Tren Harga Card -->
    <div class="glass rounded-2xl p-6 card-hover">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-purple-200 text-sm font-medium mb-1" id="sentiment-label">
                    {% if selected_jenis_data == 'komoditas' %}Tren Naik{% else %}Sentimen Positif{% endif %}
                </p>
                <p class="text-white text-3xl font-bold" id="stat-sentiment">{{ chart_data.statistics.positive_sentiment_pct }}%</p>
                <p class="text-purple-300 text-sm mt-2" id="sentiment-description">
                    <i class="fas fa-smile mr-1" id="sentiment-icon"></i>
                    <span id="sentiment-text">
                        {% if selected_jenis_data == 'komoditas' %}Price trending up{% else %}Positive sentiment{% endif %}
                    </span>
                </p>
            </div>
            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center">
                <i class="fas fa-heart text-white text-2xl" id="sentiment-card-icon"></i>
            </div>
        </div>
    </div>
</div>

<!-- Pesan jika tidak ada data -->
{% if chart_data.statistics.total_data == 0 %}
<div class="glass rounded-3xl p-12 mb-8 text-center">
    <div class="w-24 h-24 bg-gradient-to-br from-gray-500 to-gray-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-exclamation-triangle text-white text-3xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-white mb-4">Tidak Ada Data Valid</h3>
    <p class="text-blue-200 text-lg mb-6">
        Semua data telah difilter karena memiliki field yang kosong. 
        Untuk menampilkan chart trend, pastikan data CSV memiliki:
    </p>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="glass rounded-lg p-4">
            <i class="fas fa-list-alt text-blue-400 text-2xl mb-2"></i>
            <p class="text-white font-medium">Kategori</p>
            <p class="text-blue-300 text-sm">Tidak boleh kosong</p>
        </div>
        <div class="glass rounded-lg p-4">
            <i class="fas fa-file-alt text-green-400 text-2xl mb-2"></i>
            <p class="text-white font-medium">Ringkasan Fenomena</p>
            <p class="text-blue-300 text-sm">Harus terisi</p>
        </div>
        <div class="glass rounded-lg p-4">
            <i class="fas fa-heart text-purple-400 text-2xl mb-2"></i>
            <p class="text-white font-medium" id="requirement-sentiment">
                {% if selected_jenis_data == 'komoditas' %}Tren Harga{% else %}Sentiment{% endif %}
            </p>
            <p class="text-blue-300 text-sm">Harus valid</p>
        </div>
    </div>
    <button onclick="window.location.href='/fenomena'" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
        <i class="fas fa-eye mr-2"></i>
        Lihat Semua Data di Fenomena
    </button>
</div>
{% else %}

<!-- Charts Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <!-- Main Trend Chart -->
    <div class="glass rounded-3xl p-6 lg:col-span-2">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-chart-line mr-3 text-green-400"></i>
                Tren Fenomena Bulanan (Data Valid)
            </h3>
            <div class="flex space-x-2">
                <button onclick="toggleFullscreen('mainChart')" class="glass text-white px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-300" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button onclick="downloadChart('mainChart')" class="glass text-white px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-20 transition-all duration-300" title="Download">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        
        <!-- Chart Container -->
        <div id="mainChart" class="w-full h-96 bg-white bg-opacity-5 rounded-2xl flex items-center justify-center">
            <canvas id="monthlyTrendChart" class="max-w-full max-h-full"></canvas>
        </div>
    </div>

    <!-- Dynamic Sentiment/Tren Harga Distribution -->
    <div class="glass rounded-3xl p-6">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center" id="sentiment-chart-title">
            <i class="fas fa-heart mr-3 text-pink-400" id="sentiment-chart-icon"></i>
            <span id="sentiment-chart-label">
                {% if selected_jenis_data == 'komoditas' %}Distribusi Tren Harga{% else %}Distribusi Sentimen{% endif %}
            </span>
        </h3>
        
        <div id="sentimentChart" class="w-full h-64 bg-white bg-opacity-5 rounded-2xl flex items-center justify-center">
            <canvas id="sentimentPieChart" class="max-w-full max-h-full"></canvas>
        </div>
    </div>

    <!-- Dynamic Positive Category/Naik Chart -->
    <div class="glass rounded-3xl p-6">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center" id="positive-chart-title">
            <i class="fas fa-arrow-trend-up mr-3 text-green-400"></i>
            <span id="positive-chart-label">
                {% if selected_jenis_data == 'komoditas' %}Top Kategori (Tren Naik){% else %}Top Kategori (Sentimen Positif){% endif %}
            </span>
        </h3>
        
        <div id="positiveCategoryChartContainer" class="w-full h-64 bg-white bg-opacity-5 rounded-2xl flex items-center justify-center">
            <canvas id="positiveCategoryChart" class="max-w-full max-h-full"></canvas>
        </div>
    </div>
</div>

<!-- Dynamic Negative Categories Chart -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
    <div class="glass rounded-3xl p-6">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center" id="negative-chart-title">
            <i class="fas fa-arrow-trend-down mr-3 text-red-400"></i>
            <span id="negative-chart-label">
                {% if selected_jenis_data == 'komoditas' %}Top Kategori (Tren Turun){% else %}Top Kategori (Sentimen Negatif){% endif %}
            </span>
        </h3>
        
        <div id="negativeCategoryChartContainer" class="w-full h-64 bg-white bg-opacity-5 rounded-2xl flex items-center justify-center">
            <canvas id="negativeCategoryChart" class="max-w-full max-h-full"></canvas>
        </div>
    </div>

    <!-- Dynamic Summary Card -->
    <div class="glass rounded-3xl p-6">
        <h3 class="text-xl font-bold text-white mb-6 flex items-center">
            <i class="fas fa-chart-pie mr-3 text-blue-400"></i>
            Ringkasan Data Valid
        </h3>
        
        <div class="space-y-4" id="summary-content">
            <div class="flex justify-between items-center p-3 glass rounded-lg">
                <span class="text-blue-200" id="summary-positive-label">
                    {% if selected_jenis_data == 'komoditas' %}Total Naik:{% else %}Total Positif:{% endif %}
                </span>
                <span class="text-green-400 font-bold" id="summary-positive-value">
                    {{ chart_data.sentiment_distribution.Positif or chart_data.sentiment_distribution.Naik or 0 }}
                </span>
            </div>
            <div class="flex justify-between items-center p-3 glass rounded-lg">
                <span class="text-blue-200" id="summary-negative-label">
                    {% if selected_jenis_data == 'komoditas' %}Total Turun:{% else %}Total Negatif:{% endif %}
                </span>
                <span class="text-red-400 font-bold" id="summary-negative-value">
                    {{ chart_data.sentiment_distribution.Negatif or chart_data.sentiment_distribution.Turun or 0 }}
                </span>
            </div>
            <div class="flex justify-between items-center p-3 glass rounded-lg">
                <span class="text-blue-200" id="summary-neutral-label">
                    {% if selected_jenis_data == 'komoditas' %}Total Stabil:{% else %}Total Kosong:{% endif %}
                </span>
                <span class="text-yellow-400 font-bold" id="summary-neutral-value">
                    {{ chart_data.sentiment_distribution.Kosong or chart_data.sentiment_distribution.Stabil or 0 }}
                </span>
            </div>
            <div class="flex justify-between items-center p-3 glass rounded-lg border-t border-white border-opacity-20">
                <span class="text-white font-semibold">Total Valid:</span>
                <span class="text-white font-bold">{{ chart_data.statistics.total_data }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Data Insights -->
<div class="glass rounded-3xl p-8">
    <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
        <i class="fas fa-lightbulb mr-3 text-yellow-400"></i>
        Insight & Analisis Data Valid
    </h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Key Findings -->
        <div>
            <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-key mr-2 text-blue-400"></i>
                Temuan Utama
            </h4>
            <div class="space-y-4">
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full mt-2"></div>
                    <p class="text-blue-100">
                        Total {{ chart_data.statistics.total_data }} fenomena valid tercatat dengan puncak aktivitas pada bulan {{ chart_data.statistics.peak_month }}.
                    </p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-blue-400 rounded-full mt-2"></div>
                    <p class="text-blue-100" id="insight-sentiment-text">
                        {% if selected_jenis_data == 'komoditas' %}
                        Tren harga naik dominan dengan persentase {{ chart_data.statistics.positive_sentiment_pct }}% dari total data valid yang dianalisis.
                        {% else %}
                        Sentimen positif dominan dengan persentase {{ chart_data.statistics.positive_sentiment_pct }}% dari total berita valid yang dianalisis.
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-purple-400 rounded-full mt-2"></div>
                    <p class="text-blue-100">
                        {% if chart_data.statistics.growth_rate > 0 %}
                        Tren menunjukkan peningkatan {{ chart_data.statistics.growth_rate }}% dibandingkan periode sebelumnya.
                        {% elif chart_data.statistics.growth_rate < 0 %}
                        Tren menunjukkan penurunan {{ chart_data.statistics.growth_rate|abs }}% dibandingkan periode sebelumnya.
                        {% else %}
                        Tren menunjukkan kondisi stabil tanpa perubahan signifikan.
                        {% endif %}
                    </p>
                </div>
                <div class="flex items-start space-x-3">
                    <div class="w-2 h-2 bg-yellow-400 rounded-full mt-2"></div>
                    <p class="text-blue-100">
                        Data ditampilkan setelah filtering untuk memastikan kualitas analisis yang akurat.
                    </p>
                </div>
            </div>
        </div>

        <!-- Top Categories -->
        <div>
            <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-green-400"></i>
                Top 5 Kategori Valid
            </h4>
            <div class="space-y-3">
                {% for category in chart_data.category_breakdown[:5] %}
                <div class="flex items-center justify-between p-3 glass rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full"></div>
                        <span class="text-white font-medium">{{ category.category }}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-200 text-sm">{{ category.count }}</span>
                        <div class="w-16 h-2 bg-white bg-opacity-20 rounded-full">
                            <div class="h-full bg-gradient-to-r from-blue-400 to-purple-500 rounded-full" style="width: {{ (category.count / chart_data.statistics.total_data * 100) if chart_data.statistics.total_data > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if chart_data.category_breakdown|length == 0 %}
                <div class="text-center py-4">
                    <p class="text-blue-200">Tidak ada data kategori tersedia</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Hidden data for JavaScript -->
<script id="chart-data" type="application/json">{{ chart_data|tojson }}</script>
<script id="current-data-type" type="application/json">"{{ selected_jenis_data }}"</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Global variables
    let chartData;
    let monthlyChart, sentimentChart, positiveCategoryChart, negativeCategoryChart;
    let currentDataType = 'all';
    
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Get chart data and current data type from server
            const chartDataElement = document.getElementById('chart-data');
            const dataTypeElement = document.getElementById('current-data-type');
            
            if (chartDataElement) {
                chartData = JSON.parse(chartDataElement.textContent);
                console.log('Chart data loaded:', chartData);
            } else {
                console.error('Chart data element not found');
                chartData = getDefaultChartData();
            }
            
            if (dataTypeElement) {
                currentDataType = JSON.parse(dataTypeElement.textContent);
                console.log('Current data type:', currentDataType);
            }
            
            // Only initialize charts if we have data
            if (chartData.statistics.total_data > 0) {
                initializeCharts();
                setupEventListeners();
            } else {
                console.log('No data available, skipping chart initialization');
                // Update requirement sentiment label for empty data case
                updateRequirementSentimentLabel(currentDataType);
            }
            
            // Update labels based on current data type
            updateLabelsForDataType(currentDataType);
            
        } catch (error) {
            console.error('Error initializing charts:', error);
            chartData = getDefaultChartData();
            if (chartData.statistics.total_data > 0) {
                initializeCharts();
            }
        }
    });

    // Update requirement sentiment label for empty data message
    function updateRequirementSentimentLabel(dataType) {
        const requirementSentiment = document.getElementById('requirement-sentiment');
        if (requirementSentiment) {
            requirementSentiment.textContent = dataType === 'komoditas' ? 'Tren Harga' : 'Sentiment';
        }
    }

    // Handle data source change
    function handleDataSourceChange(dataType) {
        currentDataType = dataType;
        updateLabelsForDataType(dataType);
        updateRequirementSentimentLabel(dataType);
        // Submit form to reload page with new data
        document.querySelector('form').submit();
    }

    // Update all labels based on data type
    function updateLabelsForDataType(dataType) {
        const isKomoditas = dataType === 'komoditas';
        
        // Update sentiment card labels
        const sentimentLabel = document.getElementById('sentiment-label');
        const sentimentText = document.getElementById('sentiment-text');
        const sentimentIcon = document.getElementById('sentiment-icon');
        const sentimentCardIcon = document.getElementById('sentiment-card-icon');
        
        if (sentimentLabel) {
            sentimentLabel.textContent = isKomoditas ? 'Tren Naik' : 'Sentimen Positif';
        }
        if (sentimentText) {
            sentimentText.textContent = isKomoditas ? 'Price trending up' : 'Positive sentiment';
        }
        if (sentimentIcon) {
            sentimentIcon.className = isKomoditas ? 'fas fa-arrow-trend-up mr-1' : 'fas fa-smile mr-1';
        }
        if (sentimentCardIcon) {
            sentimentCardIcon.className = isKomoditas ? 'fas fa-chart-line text-white text-2xl' : 'fas fa-heart text-white text-2xl';
        }
        
        // Update chart titles
        const sentimentChartLabel = document.getElementById('sentiment-chart-label');
        const sentimentChartIcon = document.getElementById('sentiment-chart-icon');
        const positiveChartLabel = document.getElementById('positive-chart-label');
        const negativeChartLabel = document.getElementById('negative-chart-label');
        
        if (sentimentChartLabel) {
            sentimentChartLabel.textContent = isKomoditas ? 'Distribusi Tren Harga' : 'Distribusi Sentimen';
        }
        if (sentimentChartIcon) {
            sentimentChartIcon.className = isKomoditas ? 'fas fa-chart-line mr-3 text-pink-400' : 'fas fa-heart mr-3 text-pink-400';
        }
        if (positiveChartLabel) {
            positiveChartLabel.textContent = isKomoditas ? 'Top Kategori (Tren Naik)' : 'Top Kategori (Sentimen Positif)';
        }
        if (negativeChartLabel) {
            negativeChartLabel.textContent = isKomoditas ? 'Top Kategori (Tren Turun)' : 'Top Kategori (Sentimen Negatif)';
        }
        
        // Update summary labels
        const summaryPositiveLabel = document.getElementById('summary-positive-label');
        const summaryNegativeLabel = document.getElementById('summary-negative-label');
        const summaryNeutralLabel = document.getElementById('summary-neutral-label');
        
        if (summaryPositiveLabel) {
            summaryPositiveLabel.textContent = isKomoditas ? 'Total Naik:' : 'Total Positif:';
        }
        if (summaryNegativeLabel) {
            summaryNegativeLabel.textContent = isKomoditas ? 'Total Turun:' : 'Total Negatif:';
        }
        if (summaryNeutralLabel) {
            summaryNeutralLabel.textContent = isKomoditas ? 'Total Stabil:' : 'Total Kosong:';
        }
        
        // Update insight text
        const insightSentimentText = document.getElementById('insight-sentiment-text');
        if (insightSentimentText && chartData.statistics) {
            if (isKomoditas) {
                insightSentimentText.textContent = `Tren harga naik dominan dengan persentase ${chartData.statistics.positive_sentiment_pct}% dari total data valid yang dianalisis.`;
            } else {
                insightSentimentText.textContent = `Sentimen positif dominan dengan persentase ${chartData.statistics.positive_sentiment_pct}% dari total berita valid yang dianalisis.`;
            }
        }
    }

    // Default chart data structure
    function getDefaultChartData() {
        return {
            monthly_trend: [
                {month: 'Januari', count: 0}, {month: 'Februari', count: 0}, {month: 'Maret', count: 0},
                {month: 'April', count: 0}, {month: 'Mei', count: 0}, {month: 'Juni', count: 0},
                {month: 'Juli', count: 0}, {month: 'Agustus', count: 0}, {month: 'September', count: 0},
                {month: 'Oktober', count: 0}, {month: 'November', count: 0}, {month: 'Desember', count: 0}
            ],
            sentiment_distribution: {Positif: 0, Negatif: 0, Kosong: 0, Naik: 0, Turun: 0, Stabil: 0},
            category_breakdown: [],
            top_positive_categories: [],
            top_negative_categories: [],
            statistics: {
                total_data: 0,
                growth_rate: 0,
                peak_month: 'N/A',
                avg_daily: 0,
                positive_sentiment_pct: 0
            }
        };
    }

    // Initialize all charts
    function initializeCharts() {
        try {
            initializeMonthlyTrendChart();
            initializeSentimentChart();
            initializePositiveCategoryChart();
            initializeNegativeCategoryChart();
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // Monthly Trend Chart
    function initializeMonthlyTrendChart() {
        try {
            const canvas = document.getElementById('monthlyTrendChart');
            if (!canvas) {
                console.error('Monthly trend chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            const months = chartData.monthly_trend ? chartData.monthly_trend.map(item => item.month) : [];
            const counts = chartData.monthly_trend ? chartData.monthly_trend.map(item => item.count || 0) : [];
            
            // Chart type logic
            const chartTypeSelect = document.getElementById('chartType');
            const selectedOption = chartTypeSelect.options[chartTypeSelect.selectedIndex];
            const chartType = chartTypeSelect.value || 'line';
            const shouldFill = selectedOption.getAttribute('data-fill') === 'true'; 

            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            monthlyChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Jumlah Fenomena (Valid)',
                        data: counts,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: shouldFill,
                        tension: 0.4,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: getChartOptions()
            });
        } catch (error) {
            console.error('Error creating monthly trend chart:', error);
        }
    }

    // Sentiment Distribution Chart (Dynamic for Komoditas)
    function initializeSentimentChart() {
        try {
            const canvas = document.getElementById('sentimentPieChart');
            if (!canvas) {
                console.error('Sentiment chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            const sentimentData = chartData.sentiment_distribution || {};
            let labels, data, colors;
            
            // Dynamic labels and colors based on data type
            if (currentDataType === 'komoditas') {
                labels = ['Naik', 'Turun', 'Stabil'];
                data = [
                    sentimentData.Naik || sentimentData.Positif || 0,
                    sentimentData.Turun || sentimentData.Negatif || 0,
                    sentimentData.Stabil || sentimentData.Kosong || 0
                ];
                colors = {
                    'Naik': '#10b981',
                    'Turun': '#ef4444',
                    'Stabil': '#f59e0b'
                };
            } else {
                labels = ['Positif', 'Negatif', 'Kosong'];
                data = [
                    sentimentData.Positif || 0,
                    sentimentData.Negatif || 0,
                    sentimentData.Kosong || 0
                ];
                colors = {
                    'Positif': '#10b981',
                    'Negatif': '#ef4444',
                    'Kosong': '#f59e0b'
                };
            }
            
            const backgroundColors = labels.map(label => colors[label] || '#6b7280');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }
            
            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color + '80'),
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'left',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.9)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(59, 130, 246, 0.3)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    if (total === 0) return `${context.label}: 0 (0%)`;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating sentiment chart:', error);
        }
    }

    // Positive Category Chart (Dynamic labels)
    function initializePositiveCategoryChart() {
        try {
            const canvas = document.getElementById('positiveCategoryChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const categoryData = chartData.top_positive_categories || [];
            const categories = categoryData.map(item => {
                const cat = item.category || 'Unknown';
                return cat.length > 20 ? cat.substring(0, 20) + '...' : cat;
            });
            const counts = categoryData.map(item => item.count || 0);

            if (positiveCategoryChart) positiveCategoryChart.destroy();

            const labelText = currentDataType === 'komoditas' ? 'Jumlah Naik' : 'Jumlah Positif';

            positiveCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: labelText,
                        data: counts,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: getCategoryChartOptions()
            });
        } catch (error) {
            console.error('Error creating positive category chart:', error);
        }
    }

    // Negative Category Chart (Dynamic labels)
    function initializeNegativeCategoryChart() {
        try {
            const canvas = document.getElementById('negativeCategoryChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const categoryData = chartData.top_negative_categories || [];
            const categories = categoryData.map(item => {
                const cat = item.category || 'Unknown';
                return cat.length > 20 ? cat.substring(0, 20) + '...' : cat;
            });
            const counts = categoryData.map(item => item.count || 0);

            if (negativeCategoryChart) negativeCategoryChart.destroy();

            const labelText = currentDataType === 'komoditas' ? 'Jumlah Turun' : 'Jumlah Negatif';

            negativeCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: labelText,
                        data: counts,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: getCategoryChartOptions()
            });
        } catch (error) {
            console.error('Error creating negative category chart:', error);
        }
    }

    // Common chart options for main charts
    function getChartOptions() {
        return {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 12 }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 12 },
                        maxRotation: 45
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        font: { size: 14 }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    borderWidth: 1
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        };
    }

    // Chart options for category charts
    function getCategoryChartOptions() {
        return {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                y: {
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 10 }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                x: {
                    beginAtZero: true,
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        font: { size: 12 }
                    },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(59, 130, 246, 0.3)',
                    borderWidth: 1
                }
            }
        };
    }

    // Setup event listeners
    function setupEventListeners() {
        try {
            const chartTypeSelect = document.getElementById('chartType');
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', changeChartType);
            }
            
            // Add hover effects to statistics cards
            const statsCards = document.querySelectorAll('.card-hover');
            statsCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-4px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }
    }

    // Chart type change handler
    function changeChartType() {
        try {
            initializeMonthlyTrendChart();
        } catch (error) {
            console.error('Error changing chart type:', error);
        }
    }

    // Update charts function with dynamic label updates
    function updateCharts() {
        try {
            const button = event.target;
            const originalHTML = button.innerHTML;
            
            // Add loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
            button.disabled = true;
            
            // Get current data source
            const dataSource = document.getElementById('dataSource')?.value || 'all';
            currentDataType = dataSource;
            
            // Fetch updated data
            fetch(`/api/trend-data?jenis_data=${dataSource}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update global chartData
                    chartData = data;
                    
                    // Update labels for new data type
                    updateLabelsForDataType(dataSource);
                    
                    // Check if we have valid data
                    if (chartData.statistics.total_data > 0) {
                        // Destroy existing charts
                        if (monthlyChart) monthlyChart.destroy();
                        if (sentimentChart) sentimentChart.destroy();
                        if (positiveCategoryChart) positiveCategoryChart.destroy();
                        if (negativeCategoryChart) negativeCategoryChart.destroy();
                        
                        // Reinitialize charts
                        initializeCharts();
                        
                        showToast('Charts updated successfully!', 'success');
                    } else {
                        showToast('No valid data available after filtering.', 'warning');
                    }
                    
                    // Update statistics in the UI
                    updateStatistics(data.statistics);
                    
                    // Update summary values
                    updateSummaryValues(data.sentiment_distribution);
                    
                    // Reload page to show proper empty state if needed
                    if (chartData.statistics.total_data === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error updating charts:', error);
                    showToast('Failed to update charts. Please try again.', 'error');
                })
                .finally(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                });
        } catch (error) {
            console.error('Error in updateCharts function:', error);
        }
    }

    // Modifikasi fungsi updateStatistics (sekitar baris 680-690)
    function updateStatistics(stats) {
        try {
            const totalStat = document.getElementById('stat-total');
            const growthStat = document.getElementById('stat-growth');
            const peakStat = document.getElementById('stat-peak');
            const sentimentStat = document.getElementById('stat-sentiment');
            
            // Update dengan total raw data, bukan data yang sudah difilter
            if (totalStat) {
                totalStat.textContent = stats.total_raw_data || stats.total_data || 0;
            }
            if (growthStat) growthStat.textContent = (stats.growth_rate > 0 ? '+' : '') + (stats.growth_rate || 0) + '%';
            if (peakStat) peakStat.textContent = stats.peak_month || 'N/A';
            if (sentimentStat) sentimentStat.textContent = (stats.positive_sentiment_pct || 0) + '%';
        } catch (error) {
            console.error('Error updating statistics:', error);
        }
    }

    // Update summary values based on data type
    function updateSummaryValues(sentimentData) {
        try {
            const positiveValue = document.getElementById('summary-positive-value');
            const negativeValue = document.getElementById('summary-negative-value');
            const neutralValue = document.getElementById('summary-neutral-value');
            
            if (currentDataType === 'komoditas') {
                if (positiveValue) positiveValue.textContent = sentimentData.Naik || sentimentData.Positif || 0;
                if (negativeValue) negativeValue.textContent = sentimentData.Turun || sentimentData.Negatif || 0;
                if (neutralValue) neutralValue.textContent = sentimentData.Stabil || sentimentData.Kosong || 0;
            } else {
                if (positiveValue) positiveValue.textContent = sentimentData.Positif || 0;
                if (negativeValue) negativeValue.textContent = sentimentData.Negatif || 0;
                if (neutralValue) neutralValue.textContent = sentimentData.Kosong || 0;
            }
        } catch (error) {
            console.error('Error updating summary values:', error);
        }
    }

    // Fullscreen toggle
    function toggleFullscreen(chartId) {
        try {
            const element = document.getElementById(chartId);
            if (!element) return;
            
            if (!document.fullscreenElement) {
                element.requestFullscreen().catch(err => {
                    showToast('Failed to enter fullscreen mode', 'error');
                });
            } else {
                document.exitFullscreen();
            }
        } catch (error) {
            console.error('Error toggling fullscreen:', error);
        }
    }

    // Download chart
    function downloadChart(chartId) {
        try {
            let chart;
            if (chartId === 'mainChart') chart = monthlyChart;
            else if (chartId === 'sentimentChart') chart = sentimentChart;
            else if (chartId === 'positiveCategoryChart') chart = positiveCategoryChart;
            else if (chartId === 'negativeCategoryChart') chart = negativeCategoryChart;
            
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = `${chartId}_filtered_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = url;
                link.click();
                showToast('Chart downloaded successfully!', 'success');
            }
        } catch (error) {
            console.error('Error downloading chart:', error);
            showToast('Failed to download chart', 'error');
        }
    }

    // Toast notification system
    function showToast(message, type = 'info') {
        try {
            const colors = {
                success: 'from-green-500 to-green-600',
                info: 'from-blue-500 to-blue-600',
                warning: 'from-yellow-500 to-yellow-600',
                error: 'from-red-500 to-red-600'
            };
            
            const icons = {
                success: 'fa-check',
                info: 'fa-info',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times'
            };
            
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 bg-gradient-to-r ${colors[type]} text-white px-6 py-3 rounded-xl z-50 transform translate-x-full transition-transform duration-300 shadow-lg`;
            toast.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${icons[type]}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        } catch (error) {
            console.error('Error showing toast:', error);
        }
    }

    // Handle form submission for data source change
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const submitButton = this.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
                }
            });
        }
    });

    // Animate statistics cards
    const statsCards = document.querySelectorAll('.glass');
    statsCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-fade-in');
    });

</script>

{% endblock %}