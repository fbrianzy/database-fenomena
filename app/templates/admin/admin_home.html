{% extends "base.html" %}
{% block title %}Admin – Data Hub{% endblock %}

{% block content %}
<div class="glass rounded-2xl p-6 mb-6">
  <div class="flex items-center justify-between gap-3">
    <div>
      <h1 class="text-2xl font-bold text-white">Admin Panel</h1>
      <p class="text-blue-100 mt-1">CRUD berbasis GitHub (create/update file langsung di repo).</p>
    </div>

    <div class="flex items-center gap-2">
      <button type="button" onclick="refreshCache(this)" class="bg-white/10 text-blue-100 px-4 py-2 rounded-xl hover:bg-white/20">
        Refresh Cache
      </button>
      <form method="post" action="{{ url_for('admin.logout') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="bg-white/10 text-blue-100 px-4 py-2 rounded-xl hover:bg-white/20">
          Logout
        </button>
      </form>
      <a href="{{ url_for('admin.admin_upload') }}"
         class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700">
        Upload + Bersihkan CSV
      </a>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Kartu: Lapangan Usaha -->
  <div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold text-white">Lapangan Usaha</h2>
      <span class="text-blue-200 text-xs">data/lapangan_usaha</span>
    </div>
    <div class="space-y-2">
      {% if lu %}
        {% for it in lu %}
        <div class="bg-white/5 rounded-lg p-3 flex items-center justify-between">
          <div class="min-w-0">
            <p class="text-white text-sm font-medium truncate">{{ it.name }}</p>
            <div class="flex items-center gap-3">
              <a class="text-blue-300 text-xs break-all hover:underline" href="{{ it.html_url }}" target="_blank">
                Lihat di GitHub
              </a>
              <a class="text-green-300 text-xs hover:underline"
                href="{{ url_for('admin.admin_table') }}?path={{ it.path }}">
                Lihat &amp; Edit
              </a>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-blue-200 text-xs whitespace-nowrap">{{ (it.size/1024)|round(1) }} KB</span>
            <form method="post" action="{{ url_for('admin.api_delete_file') }}"
                  onsubmit="return confirm('Hapus file ini dari repo?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="path" value="{{ it.path }}">
              <button class="text-red-300 text-xs hover:underline">Hapus</button>
            </form>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-blue-200 text-sm">Belum ada CSV ditemukan.</p>
      {% endif %}
    </div>
  </div>

  <!-- Kartu: Pengeluaran -->
  <div class="glass rounded-2xl p-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold text-white">Pengeluaran</h2>
      <span class="text-blue-200 text-xs">data/pengeluaran</span>
    </div>
    <div class="space-y-2">
      {% if pengeluaran %}
        {% for it in pengeluaran %}
        <div class="bg-white/5 rounded-lg p-3 flex items-center justify-between">
          <div class="min-w-0">
            <p class="text-white text-sm font-medium truncate">{{ it.name }}</p>
            <div class="flex items-center gap-3">
              <a class="text-blue-300 text-xs break-all hover:underline" href="{{ it.html_url }}" target="_blank">
                Lihat di GitHub
              </a>
              <a class="text-green-300 text-xs hover:underline"
                href="{{ url_for('admin.admin_table') }}?path={{ it.path }}">
                Lihat &amp; Edit
              </a>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <span class="text-blue-200 text-xs whitespace-nowrap">{{ (it.size/1024)|round(1) }} KB</span>
            <form method="post" action="{{ url_for('admin.api_delete_file') }}"
                  onsubmit="return confirm('Hapus file ini dari repo?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
              <input type="hidden" name="path" value="{{ it.path }}">
              <button class="text-red-300 text-xs hover:underline">Hapus</button>
            </form>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-blue-200 text-sm">Belum ada CSV ditemukan.</p>
      {% endif %}
    </div>
  </div>

</div>

<script>
async function refreshCache(btn){
  try{
    btn?.classList.add('btn-loading');
    const res = await fetch('/admin/clear-cache', {
      method: 'POST',
      headers: { 'X-CSRF-Token': {{ csrf_token|tojson }} }
    });
    const json = await res.json();
    if(res.ok){
      if(window.showToast) showToast('Cache dibersihkan ✓', 'success');
      // reload daftar file supaya refleksikan state terbaru
      setTimeout(()=>location.reload(), 450);
    }else{
      if(window.showToast) showToast(json?.message || json?.error || 'Gagal clear cache', 'error');
    }
  }catch(e){
    if(window.showToast) showToast('Jaringan bermasalah', 'error');
  }finally{
    btn?.classList.remove('btn-loading');
  }
}
</script>
{% endblock %}
